<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>üçÖ Mission Control</title>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--card:#12121a;--border:#1e1e2e;--text:#e0e0e8;--dim:#6b6b80;--accent:#10b981;--accent2:#6366f1;--warn:#f59e0b;--red:#ef4444;--blue:#3b82f6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* Top bar */
.top-bar{position:sticky;top:0;z-index:20;background:rgba(10,10,15,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.top-bar h1{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
.top-bar .meta{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.refresh-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Tab bar */
.tab-bar{position:sticky;top:41px;z-index:15;background:rgba(10,10,15,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);display:flex;gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tab-bar::-webkit-scrollbar{display:none}
.tab-btn{flex:1;min-width:0;padding:10px 8px;background:none;border:none;color:var(--dim);font-family:'Inter',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;text-align:center;display:flex;align-items:center;justify-content:center;gap:4px}
.tab-btn:hover{color:var(--text);background:rgba(255,255,255,.03)}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-btn .tab-icon{font-size:14px}
.tab-btn .tab-label{font-size:12px}
@media(max-width:400px){.tab-btn .tab-label{display:none}.tab-btn .tab-icon{font-size:18px}.tab-btn{padding:10px 12px}}

/* Tab content */
.tab-content{display:none}
.tab-content.active{display:block}

/* Pixel Room */
.room-wrap{background:var(--card);border:1px solid var(--border);border-radius:12px;margin:12px 12px 0;overflow:hidden;position:relative}
.room-canvas{width:100%;display:block;image-rendering:pixelated;image-rendering:crisp-edges;cursor:pointer;background:#0a0a0f}
.room-label{position:absolute;bottom:6px;left:0;right:0;text-align:center;font-size:10px;color:var(--dim);font-family:'DotGothic16','JetBrains Mono',monospace;pointer-events:none;text-shadow:0 1px 3px rgba(0,0,0,.8)}
.room-state{position:absolute;top:6px;right:8px;font-size:9px;padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;background:rgba(16,185,129,.15);color:var(--accent);pointer-events:none}
.room-state.thinking{background:rgba(245,158,11,.15);color:var(--warn)}
.room-state.sleeping{background:rgba(107,107,128,.15);color:var(--dim)}

/* Grid */
.grid{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:800px;margin:0 auto}
@media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;transition:border-color .2s}
.card:hover{border-color:#2a2a40}
.card-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.card-full{grid-column:1/-1}

/* Agent */
.agent-row{display:flex;align-items:center;gap:12px}
.agent-avatar{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#ef4444,#f97316);display:flex;align-items:center;justify-content:center;font-size:24px}
.agent-info{flex:1}
.agent-name{font-size:18px;font-weight:700}
.agent-status{font-size:12px;display:flex;align-items:center;gap:6px;margin-top:2px}
.status-dot{width:8px;height:8px;border-radius:50%}
.status-dot.active{background:var(--accent)}
.status-dot.thinking{background:var(--warn);animation:pulse 1s infinite}
.status-dot.sleeping{background:var(--dim)}
.agent-meta{font-size:11px;color:var(--dim);margin-top:4px;font-family:'JetBrains Mono',monospace}

/* Thinking Nodes */
.node{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.node:last-child{border-bottom:none}
.node-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.node-dot.active{background:var(--accent)}
.node-dot.completed{background:var(--dim)}
.node-id{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--accent2);min-width:100px;flex-shrink:0}
.node-summary{font-size:12px;color:var(--text);flex:1;line-height:1.4}
.node-wake{font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace;flex-shrink:0}

/* Schedule */
.sched-item{display:flex;align-items:flex-start;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)}
.sched-item:last-child{border-bottom:none}
.sched-time{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--warn);min-width:50px;flex-shrink:0}
.sched-text{font-size:12px;flex:1}
.sched-badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600;flex-shrink:0}
.sched-badge.reminder{background:rgba(245,158,11,.15);color:var(--warn)}
.sched-badge.family{background:rgba(239,68,68,.15);color:var(--red)}
.sched-badge.medical{background:rgba(59,130,246,.15);color:var(--blue)}
.sched-badge.appointment{background:rgba(99,102,241,.15);color:var(--accent2)}

/* Activity */
.act-item{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)}
.act-item:last-child{border-bottom:none}
.act-time{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--dim);min-width:44px;flex-shrink:0}
.act-dot{width:6px;height:6px;border-radius:50%;margin-top:5px;flex-shrink:0}
.act-dot.build{background:var(--accent)}
.act-dot.deploy{background:var(--blue)}
.act-dot.thinking{background:var(--accent2)}
.act-dot.health{background:var(--red)}
.act-dot.system{background:var(--warn)}
.act-text{font-size:12px;flex:1;line-height:1.4}

/* Projects */
.proj{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.proj:last-child{border-bottom:none}
.proj-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.proj-icon.deployed{background:rgba(16,185,129,.15)}
.proj-icon.building{background:rgba(245,158,11,.15)}
.proj-icon.maintenance{background:rgba(99,102,241,.15)}
.proj-info{flex:1}
.proj-name{font-size:13px;font-weight:600}
.proj-ver{font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.proj-status{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.proj-status.deployed{background:rgba(16,185,129,.15);color:var(--accent)}
.proj-status.building{background:rgba(245,158,11,.15);color:var(--warn);animation:pulse 1.5s infinite}
.proj-status.maintenance{background:rgba(99,102,241,.15);color:var(--accent2)}
.proj a{color:var(--blue);font-size:10px;text-decoration:none;font-family:'JetBrains Mono',monospace}

/* Stats */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat-box{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center}
.stat-num{font-size:24px;font-weight:700;color:var(--accent)}
.stat-label{font-size:10px;color:var(--dim);margin-top:2px}

/* Inner State */
.inner-mood{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.mood-emoji{font-size:32px}
.mood-info{flex:1}
.mood-text{font-size:14px;font-weight:600}
.mood-time{font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace;margin-top:2px}
.energy-bar{height:4px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden}
.energy-fill{height:100%;border-radius:2px;transition:width .5s}
.bar-label{display:flex;justify-content:space-between;font-size:9px;color:var(--dim);margin-top:3px;font-family:'JetBrains Mono',monospace}
.feeling-text{font-size:12px;line-height:1.7;color:var(--text);padding:10px;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:8px;margin-top:10px}
.thought-text{font-size:12px;line-height:1.7;color:var(--text);font-style:italic;padding:10px;background:rgba(99,102,241,.05);border-left:2px solid var(--accent2);margin-top:8px}
.concern{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.concern:last-child{border-bottom:none}
.concern-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:5px}
.concern-dot.high{background:var(--red)}
.concern-dot.mid{background:var(--warn)}
.concern-dot.low{background:var(--dim)}
.family-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.family-item:last-child{border-bottom:none}
.family-emoji{font-size:20px;flex-shrink:0;width:28px;text-align:center}
.family-who{font-size:12px;font-weight:600;color:var(--accent2)}
.family-note{font-size:11px;color:var(--text);line-height:1.6;margin-top:2px}
.reflection-text{font-size:11px;line-height:1.6;color:var(--dim);padding:8px;background:rgba(255,255,255,.02);border-radius:6px}

/* Footer */
.footer{text-align:center;padding:16px;font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace}

/* ===== TASK BOARD ===== */
.kanban{display:flex;gap:12px;padding:12px;max-width:1000px;margin:0 auto;overflow-x:auto;-webkit-overflow-scrolling:touch}
.kanban-col{flex:1;min-width:240px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column}
.kanban-col-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.kanban-col-title .col-count{font-size:10px;color:var(--dim);font-weight:400}
.col-todo .kanban-col-title{color:var(--warn)}
.col-progress .kanban-col-title{color:var(--blue)}
.col-done .kanban-col-title{color:var(--accent)}
.task-card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;transition:border-color .2s}
.task-card:hover{border-color:#2a2a40}
.task-card:last-child{margin-bottom:0}
.task-title{font-size:13px;font-weight:600;margin-bottom:4px}
.task-desc{font-size:11px;color:var(--dim);line-height:1.5;margin-bottom:8px}
.task-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.task-assignee{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,.05);font-weight:500}
.task-priority{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;text-transform:uppercase}
.task-priority.high{background:rgba(239,68,68,.15);color:var(--red)}
.task-priority.mid{background:rgba(245,158,11,.15);color:var(--warn)}
.task-priority.low{background:rgba(107,107,128,.15);color:var(--dim)}
.task-date{font-size:9px;color:var(--dim);font-family:'JetBrains Mono',monospace;margin-left:auto}
.task-actions{display:flex;gap:4px;margin-top:8px}
.task-move{font-size:10px;padding:3px 8px;border-radius:4px;border:1px solid var(--border);background:none;color:var(--dim);cursor:pointer;font-family:'Inter',sans-serif;transition:all .2s}
.task-move:hover{border-color:var(--accent);color:var(--accent);background:rgba(16,185,129,.08)}

/* ===== CALENDAR ===== */
.cal-wrap{padding:12px;max-width:800px;margin:0 auto}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cal-title{font-size:18px;font-weight:700}
.cal-nav{display:flex;gap:8px}
.cal-nav-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.cal-nav-btn:hover{border-color:var(--accent);color:var(--accent)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-dow{text-align:center;font-size:10px;font-weight:600;color:var(--dim);padding:6px 0;text-transform:uppercase}
.cal-day{background:var(--card);border:1px solid var(--border);border-radius:6px;min-height:52px;padding:4px;cursor:pointer;transition:all .2s;position:relative}
.cal-day:hover{border-color:#2a2a40;background:rgba(255,255,255,.02)}
.cal-day.today{border-color:var(--accent);background:rgba(16,185,129,.05)}
.cal-day.other-month{opacity:.3}
.cal-day.selected{border-color:var(--accent2);background:rgba(99,102,241,.08)}
.cal-day-num{font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}
.cal-dots{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap}
.cal-dot{width:5px;height:5px;border-radius:50%}
.cal-dot.reminder{background:var(--warn)}
.cal-dot.family{background:var(--red)}
.cal-dot.medical{background:var(--blue)}
.cal-dot.appointment{background:var(--accent2)}
.cal-events{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px}
.cal-events-title{font-size:12px;font-weight:700;margin-bottom:8px;color:var(--accent2)}
.cal-event-item{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.cal-event-item:last-child{border-bottom:none}
.cal-event-time{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--warn);min-width:44px;flex-shrink:0}
.cal-event-badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600;flex-shrink:0}

/* ===== TEAM ===== */
.team-wrap{padding:12px;max-width:800px;margin:0 auto}
.team-grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:640px){.team-grid{grid-template-columns:1fr 1fr}}
.team-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;transition:border-color .2s}
.team-card:hover{border-color:#2a2a40}
.team-card.active-agent{border-color:rgba(16,185,129,.3)}
.team-avatar{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0}
.team-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.team-name{font-size:16px;font-weight:700}
.team-model{font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace;margin-top:2px}
.team-role{font-size:11px;color:var(--text);line-height:1.5;padding:8px;background:rgba(255,255,255,.02);border-radius:6px;margin-bottom:8px}
.team-status{display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600}
.team-status.active{background:rgba(16,185,129,.15);color:var(--accent)}
.team-status.standby{background:rgba(107,107,128,.15);color:var(--dim)}
.team-status.working{background:rgba(245,158,11,.15);color:var(--warn)}
.team-flow{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:12px}
.team-flow-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);margin-bottom:12px}
.flow-diagram{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;padding:16px 0}
.flow-node{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 16px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;min-width:80px}
.flow-node.primary{border-color:rgba(16,185,129,.3);background:rgba(16,185,129,.05)}
.flow-emoji{font-size:28px}
.flow-name{font-size:11px;font-weight:600}
.flow-role{font-size:9px;color:var(--dim)}
.flow-arrow{font-size:18px;color:var(--dim)}
.subagent-section{margin-top:12px}
.subagent-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);margin-bottom:8px}
.subagent-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.subagent-item:last-child{border-bottom:none}
.subagent-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.subagent-dot.running{background:var(--warn);animation:pulse 1.5s infinite}
.subagent-dot.done{background:var(--accent)}

@media(max-width:639px){
  .node-id{min-width:70px;font-size:10px}
  .node-summary{font-size:11px}
  .grid{padding:8px}
  .room-wrap{margin:8px 8px 0}
  .kanban{flex-direction:column;padding:8px}
  .kanban-col{min-width:0}
  .cal-wrap{padding:8px}
  .cal-day{min-height:40px}
  .cal-day-num{font-size:10px}
  .team-wrap{padding:8px}
}
</style>
</head>
<body>
<div class="top-bar">
  <h1><span>üçÖ</span> Mission Control</h1>
  <div style="display:flex;align-items:center;gap:8px">
    <div class="refresh-dot" id="refresh-dot"></div>
    <span class="meta" id="last-update">--</span>
  </div>
</div>

<!-- Tab Bar -->
<div class="tab-bar">
  <button class="tab-btn active" data-tab="dashboard"><span class="tab-icon">üìä</span><span class="tab-label">Dashboard</span></button>
  <button class="tab-btn" data-tab="tasks"><span class="tab-icon">üìã</span><span class="tab-label">Tasks</span></button>
  <button class="tab-btn" data-tab="calendar"><span class="tab-icon">üìÖ</span><span class="tab-label">Calendar</span></button>
  <button class="tab-btn" data-tab="team"><span class="tab-icon">üë•</span><span class="tab-label">Team</span></button>
</div>

<!-- ===== DASHBOARD TAB ===== -->
<div class="tab-content active" id="tab-dashboard">
  <!-- Pixel Room -->
  <div class="room-wrap" style="max-width:776px;margin-left:auto;margin-right:auto">
    <canvas id="room-canvas" class="room-canvas"></canvas>
    <div class="room-state" id="room-state">‚óè ACTIVE</div>
    <div class="room-label" id="room-label">üçÖ Tomato's Room ‚Äî tap to say hi!</div>
  </div>

  <div class="grid" id="dashboard">
    <div class="card" id="agent-card">
      <div class="card-title">ü§ñ Agent Status</div>
      <div id="agent-content">Loading...</div>
    </div>
    <div class="card" id="stats-card">
      <div class="card-title">üìä Statistics</div>
      <div id="stats-content"></div>
    </div>
    <div class="card card-full" id="inner-card">
      <div class="card-title">üß† Inner State ‚Äî ‰ªä„ÅÆÁßÅ</div>
      <div id="inner-content"></div>
    </div>
    <div class="card card-full" id="family-card">
      <div class="card-title">‚ù§Ô∏è Family Watch</div>
      <div id="family-content"></div>
    </div>
    <div class="card card-full" id="reflection-card">
      <div class="card-title">ü™û Self-Reflection</div>
      <div id="reflection-content"></div>
    </div>
    <div class="card card-full" id="schedule-card">
      <div class="card-title">üìÖ Schedule</div>
      <div id="schedule-content"></div>
    </div>
    <div class="card card-full" id="activity-card">
      <div class="card-title">‚ö° Recent Activity</div>
      <div id="activity-content"></div>
    </div>
    <div class="card card-full" id="thinking-card">
      <div class="card-title">üß† Thinking Buffer <span style="font-size:9px;color:var(--dim);font-weight:400;text-transform:none;letter-spacing:0" id="node-count"></span></div>
      <div id="thinking-content"></div>
    </div>
    <div class="card card-full" id="projects-card">
      <div class="card-title">üöÄ Projects</div>
      <div id="projects-content"></div>
    </div>
  </div>
</div>

<!-- ===== TASKS TAB ===== -->
<div class="tab-content" id="tab-tasks">
  <div class="kanban" id="kanban-board"></div>
</div>

<!-- ===== CALENDAR TAB ===== -->
<div class="tab-content" id="tab-calendar">
  <div class="cal-wrap">
    <div class="cal-header">
      <div class="cal-nav">
        <button class="cal-nav-btn" id="cal-prev">‚óÄ</button>
      </div>
      <div class="cal-title" id="cal-title"></div>
      <div class="cal-nav">
        <button class="cal-nav-btn" id="cal-next">‚ñ∂</button>
      </div>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
    <div class="cal-events" id="cal-events" style="display:none">
      <div class="cal-events-title" id="cal-events-title"></div>
      <div id="cal-events-list"></div>
    </div>
  </div>
</div>

<!-- ===== TEAM TAB ===== -->
<div class="tab-content" id="tab-team">
  <div class="team-wrap" id="team-content"></div>
</div>

<div class="footer">Auto-refresh: 10s ¬∑ v0.5 LIVE ¬∑ Powered by OpenClaw + Supabase Storage üçÖ</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ===== PIXEL ROOM ENGINE =====
class PixelRoom {
  constructor(canvas) {
    this.c = canvas;
    this.x = canvas.getContext('2d');
    this.W = 256; this.H = 144;
    canvas.width = this.W; canvas.height = this.H;
    this.x.imageSmoothingEnabled = false;
    this.f = 0;
    this.state = 'typing';
    this.monitorLines = [
      '> systems online',
      '> heartbeat OK',
      '> thinking...',
      '> touching nodes',
      '> backup done ‚úì',
      '> building...',
      '> deploy OK ‚úì',
      '> all nominal',
    ];
    this.particles = [];
    this.tapAnim = 0;
    // Stars
    this.stars = Array.from({length:15}, () => ({
      x: 30 + Math.random()*46, y: 18 + Math.random()*38,
      sp: .3 + Math.random()*2
    }));
    // Offscreen static
    this.bg = document.createElement('canvas');
    this.bg.width = this.W; this.bg.height = this.H;
    const bx = this.bg.getContext('2d');
    bx.imageSmoothingEnabled = false;
    this._drawRoom(bx);
    // Foreground offscreen (desk, items ON desk ‚Äî drawn OVER character for depth)
    this.fg = document.createElement('canvas');
    this.fg.width = this.W; this.fg.height = this.H;
    const fgx = this.fg.getContext('2d');
    fgx.imageSmoothingEnabled = false;
    this._drawFG(fgx);
    // Events
    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const sx = (e.clientX - rect.left) / rect.width * this.W;
      const sy = (e.clientY - rect.top) / rect.height * this.H;
      this._tap(sx, sy);
    });
  }

  R(ctx,x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }

  _drawRoom(s) {
    const r = (x,y,w,h,c) => this.R(s,x,y,w,h,c);
    // Wall
    r(0,0,256,100,'#16162a');
    for(let y=0;y<100;y+=12) r(0,y,256,1,'#1a1a30');
    // Baseboard
    r(0,98,256,3,'#3d2614'); r(0,98,256,1,'#4a3020');
    // Floor
    for(let y=101;y<144;y+=5){
      r(0,y,256,4,y%10<5?'#5c3a21':'#6b4226');
      r(0,y,256,1,'#4a3020');
    }
    for(let x=0;x<256;x+=28){
      const off=(Math.floor(x/28)%2)*14;
      for(let y=101;y<144;y+=10) r(x+off,y,1,5,'#3d2614');
    }
    // Window
    r(26,14,54,54,'#5c3a21'); r(28,16,50,50,'#6b4226');
    r(30,18,46,46,'#0c1445');
    r(52,18,2,46,'#5c3a21'); r(30,40,46,2,'#5c3a21');
    r(24,66,58,4,'#6b4226'); r(24,66,58,1,'#8B6E4C');
    // Curtains
    r(27,16,4,50,'#4a3060'); r(75,16,4,50,'#4a3060');
    for(let i=0;i<5;i++){r(27,16+i*10,4,2,'#5a4070');r(75,16+i*10,4,2,'#5a4070');}
    // Chair BACK only (behind character)
    r(101,76,3,16,'#3d3d5c'); r(104,76,1,16,'#2d2d4a');
    // Bookshelf
    r(210,18,40,82,'#5c3a21');
    r(212,20,36,25,'#3d2614'); r(212,47,36,25,'#3d2614'); r(212,74,36,24,'#3d2614');
    r(210,45,40,2,'#6b4226'); r(210,72,40,2,'#6b4226');
    // Books
    const bk1=['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#06b6d4'];
    bk1.forEach((c,i)=>{r(213+i*4,22,3+(i%2),22,c);r(213+i*4,22,3+(i%2),1,'rgba(255,255,255,.15)');});
    const bk2=['#14b8a6','#f43f5e','#a855f7','#84cc16','#f59e0b','#6366f1'];
    bk2.forEach((c,i)=>{r(213+i*5,49,3+(i%3===0?1:0),22,c);});
    r(213,76,4,20,'#ef4444');r(218,76,3,20,'#3b82f6');r(222,76,5,20,'#22c55e');
    // Trophy on shelf
    r(234,86,4,8,'#fcd34d');r(235,84,2,2,'#fcd34d');r(233,94,8,2,'#d4a00a');
    // Gemini crystal on shelf
    r(228,81,2,3,'#818cf8');r(227,83,4,4,'#6366f1');r(228,87,2,3,'#818cf8');
    r(228,83,1,1,'#c4b5fd');
    // Wall clock
    r(90,24,14,14,'#4a3020'); r(91,25,12,12,'#e2e8f0');
    r(96,26,2,1,'#333');r(96,35,2,1,'#333');r(91,30,1,2,'#333');r(102,30,1,2,'#333');
    // Poster
    r(155,22,24,32,'#3d2614');r(157,24,20,28,'#1a3a5c');
    r(159,44,16,6,'#22c55e');r(163,36,8,8,'#6b7280');r(165,34,4,2,'#9ca3af');
    r(172,26,4,4,'#fcd34d');
  }

  _drawFG(s) {
    const r = (x,y,w,h,c) => this.R(s,x,y,w,h,c);
    // Chair seat + legs + armrest (in front of character)
    r(100,88,18,3,'#3d3d5c'); r(100,88,18,1,'#4d4d6c');
    r(103,91,2,16,'#2d2d4a'); r(114,91,2,16,'#2d2d4a');
    r(120,82,2,8,'#3d3d5c'); // armrest
    // Desk surface
    r(86,90,112,3,'#a07850'); r(86,90,112,1,'#b8926a');
    // Desk body + legs
    r(86,93,112,7,'#6b4226');
    r(88,100,4,18,'#5c3a21'); r(192,100,4,18,'#5c3a21');
    r(87,100,6,3,'#6b4226'); r(191,100,6,3,'#6b4226');
    // Drawer
    r(170,93,24,6,'#5c3a21'); r(171,94,22,4,'#4a3020');
    r(180,95,4,1,'#8B6E4C');
    // Monitor + stand
    r(154,90,6,2,'#2a2a2a'); r(148,91,18,1,'#333');
    r(138,62,38,28,'#1a1a1a'); r(140,64,34,24,'#0a1a0a');
    r(138,62,38,1,'#333'); r(138,62,1,28,'#333'); r(175,62,1,28,'#333');
    r(174,88,2,1,'#22c55e'); // LED
    // Keyboard
    r(140,87,26,3,'#333');
    for(let kx=141;kx<165;kx+=3){r(kx,87,2,1,'#555');r(kx,89,2,1,'#444');}
    // Mouse
    r(168,88,5,3,'#444'); r(169,88,3,1,'#666');
    // Coffee cup
    r(128,84,7,6,'#e2e8f0'); r(126,85,2,3,'#cbd5e1');
    r(129,85,5,1,'#8B6E4C');
    // Plant
    r(196,84,7,6,'#8B5E3C'); r(196,84,7,1,'#a07850');
    r(198,80,3,4,'#22c55e'); r(196,78,3,3,'#16a34a'); r(201,79,3,2,'#22c55e');
    r(199,77,2,2,'#15803d');
    // GPT robot on desk
    r(184,83,7,7,'#94a3b8'); r(185,81,5,3,'#b0b8c4');
    r(187,79,1,2,'#ef4444'); r(186,79,3,1,'#f87171');
    r(186,82,1,1,'#22c55e'); r(188,82,1,1,'#22c55e');
    r(185,83,1,1,'#64748b');r(190,83,1,1,'#64748b');
    // Rug on floor
    r(96,108,72,14,'#4a2040'); r(97,109,70,12,'#5c2854');
    r(100,112,64,6,'#6b3068'); r(100,112,64,1,'#7a3a78');
    for(let rx=104;rx<160;rx+=8){r(rx,114,4,2,'#8b4088');}
  }

  _drawDynamic() {
    const x = this.x, f = this.f;
    const r = (px,py,w,h,c) => this.R(x,px,py,w,h,c);

    // === LAYER 1: BACKGROUND (wall, floor, window, bookshelf, chair back) ===
    x.drawImage(this.bg, 0, 0);

    // Stars (in window)
    this.stars.forEach(s => {
      const b = (Math.sin(f*.05*s.sp+s.x)+1)/2;
      const a = Math.floor(60+b*195).toString(16).padStart(2,'0');
      if((s.x<52||s.x>54)&&(s.y<40||s.y>42))
        r(Math.round(s.x),Math.round(s.y),1,1,'#ffffff'+a);
    });
    // Moon
    r(66,22,5,5,'#fcd34d');r(68,22,4,3,'#0c1445');
    x.fillStyle='rgba(252,211,77,.04)';x.fillRect(62,18,12,12);
    // Clock hands
    const now=new Date(), hA=(now.getHours()%12+now.getMinutes()/60)/12, mA=now.getMinutes()/60;
    r(97,31,1,1,'#333');
    r(97+Math.round(Math.sin(hA*Math.PI*2)*3),31-Math.round(Math.cos(hA*Math.PI*2)*3),1,1,'#333');
    r(97+Math.round(Math.sin(mA*Math.PI*2)*4),31-Math.round(Math.cos(mA*Math.PI*2)*4),1,1,'#999');
    // Gemini sparkle (on bookshelf = bg layer, but drawn dynamically)
    if(f%40<3){r(229,82,1,1,'#fff');r(227,85,1,1,'#e0e7ff');}

    // === LAYER 2: CHARACTER (between bg and fg for proper depth) ===
    this._drawChar(x,r,f);

    // === LAYER 3: FOREGROUND (desk, items ON desk, chair seat/legs, rug) ===
    x.drawImage(this.fg, 0, 0);

    // === LAYER 4: DYNAMIC FOREGROUND EFFECTS (on top of fg items) ===
    // Monitor text
    x.fillStyle='#22c55e';x.font='4px monospace';
    const sl=Math.floor(f/90)%this.monitorLines.length;
    for(let i=0;i<5;i++){
      const li=(sl+i)%this.monitorLines.length;
      const txt=this.monitorLines[li].substring(0,14);
      x.globalAlpha=i===0?.5:i===4?.6:1;
      x.fillText(txt,142,70+i*4);
    }
    x.globalAlpha=1;
    x.fillStyle='rgba(34,197,94,.03)';x.fillRect(128,60,55,35);
    // Coffee steam
    if(this.state!=='sleeping'){
      for(let i=0;i<2;i++){
        const sy=80-(f*0.3+i*8)%16;
        const sa=1-((f*0.3+i*8)%16)/16;
        if(sa>0){x.fillStyle=`rgba(200,200,220,${sa*.3})`;
        x.fillRect(131+Math.sin(f*.08+i)*1.5,sy,1,1);}
      }
    }
    // GPT robot eye blink
    if(f%200>195){r(186,82,1,1,'#064e3b');r(188,82,1,1,'#064e3b');}
    else{r(186,82,1,1,'#22c55e');r(188,82,1,1,'#22c55e');}
    if(f%30<15) r(187,79,1,1,'#fca5a5');
    // Keyboard highlight (typing state)
    if(this.state==='typing'&&f%8<4) r(143+(f%5)*4,87,2,1,'#777');

    // === LAYER 5: PARTICLES (always on top) ===
    this.particles=this.particles.filter(p=>p.life>0);
    this.particles.forEach(p=>{
      p.x+=p.vx||0;p.y+=p.vy||0;p.life-=p.decay||.02;
      x.globalAlpha=Math.max(0,p.life);
      if(p.ch){x.fillStyle=p.color;x.font=(p.sz||5)+'px sans-serif';x.fillText(p.ch,p.x,p.y);}
      else{x.fillStyle=p.color;x.fillRect(Math.round(p.x),Math.round(p.y),p.w||1,p.h||1);}
    });
    x.globalAlpha=1;
  }

  _drawChar(x,r,f) {
    let cx=108, cy=78; // positioned so lower body is behind desk (fg layer)
    const br=Math.sin(f*.06)*.5;
    cy+=Math.round(br);
    const st=this.state, tap=this.tapAnim>0;

    if(st==='sleeping'){this._drawSleep(x,r,f);return;}

    // Stem + leaves
    r(cx+3,cy-2,4,2,'#15803d');r(cx+4,cy-3,2,1,'#22c55e');
    r(cx+2,cy-1,2,1,'#16a34a');r(cx+6,cy-1,2,1,'#16a34a');
    // Head
    r(cx+1,cy,8,7,'#ef4444');r(cx,cy+1,10,5,'#ef4444');
    r(cx+1,cy+1,8,1,'#f87171');
    // Face
    r(cx+2,cy+3,6,3,'#fcd34d');
    // Eyes
    if(f%160<4){r(cx+3,cy+3,2,1,'#92400e');r(cx+6,cy+3,2,1,'#92400e');}
    else{
      r(cx+3,cy+3,2,2,'#fff');r(cx+6,cy+3,2,2,'#fff');
      r(cx+4,cy+4,1,1,'#1e1b4b');r(cx+7,cy+4,1,1,'#1e1b4b');
      r(cx+3,cy+3,1,1,'#fff');r(cx+6,cy+3,1,1,'#fff');
    }
    // Blush
    r(cx+2,cy+4,1,1,'#fda4af');r(cx+8,cy+4,1,1,'#fda4af');
    // Mouth
    if(tap){r(cx+4,cy+5,3,1,'#92400e');r(cx+5,cy+6,1,1,'#92400e');}
    else if(st==='thinking'){r(cx+5,cy+5,2,1,'#b91c1c');}
    else{r(cx+4,cy+5,2,1,'#b91c1c');}

    // Body (upper part visible above desk)
    r(cx+2,cy+7,6,5,'#e2e8f0');r(cx+2,cy+7,6,1,'#f8fafc');
    // Arms (reach toward desk/keyboard area)
    if(tap){
      r(cx+8,cy+7,2,2,'#fcd34d');r(cx+9,cy+5,2,2,'#fcd34d');
      r(cx,cy+8,2,3,'#fcd34d');
    }else if(st==='typing'){
      const up=f%16<8;
      r(cx,cy+8,2,up?2:3,'#fcd34d');r(cx+8,cy+8,2,up?3:2,'#fcd34d');
    }else if(st==='thinking'){
      r(cx,cy+8,2,3,'#fcd34d');
      r(cx+8,cy+7,2,1,'#fcd34d');r(cx+9,cy+5,1,2,'#fcd34d');
    }else{
      r(cx,cy+8,2,3,'#fcd34d');r(cx+8,cy+8,2,3,'#fcd34d');
    }
    // Legs + feet (will be hidden by desk foreground layer)
    r(cx+2,cy+12,3,2,'#334155');r(cx+6,cy+12,3,2,'#334155');
    r(cx+1,cy+14,3,1,'#5c3a21');r(cx+6,cy+14,3,1,'#5c3a21');

    // State effects
    if(st==='thinking'&&f%25===0) this._spawnBubble(cx+5,cy-5);
    if(st==='typing'&&f%6===0) this._spawnSpark(146+Math.random()*16,86);
    if(tap&&f%3===0) this.particles.push({
      x:cx+8+Math.random()*4,y:cy-2,vx:(Math.random()-.5)*.5,vy:-.4-Math.random()*.3,
      life:1,color:'#ef4444',ch:'‚ô•',sz:4,decay:.025
    });
  }

  _drawSleep(x,r,f) {
    const cx=124, cy=88; // arms rest right on desk surface (fg desk at y=90)
    // Arms on desk (just above desk surface)
    r(cx-2,cy,14,3,'#fcd34d');r(cx,cy-1,4,1,'#e2e8f0');r(cx+6,cy-1,4,1,'#e2e8f0');
    // Head sideways resting on arms
    r(cx+1,cy-7,8,7,'#ef4444');r(cx,cy-6,10,5,'#ef4444');
    r(cx+9,cy-8,2,2,'#22c55e');
    // Face
    r(cx+2,cy-4,5,3,'#fcd34d');
    r(cx+3,cy-3,2,1,'#92400e');r(cx+6,cy-3,2,1,'#92400e');
    r(cx+2,cy-2,1,1,'#fda4af');r(cx+7,cy-2,1,1,'#fda4af');
    r(cx+4,cy-1,2,1,'#b91c1c');
    // Body (partially hidden by desk fg)
    r(cx+2,cy+2,6,4,'#e2e8f0');
    // ZZZ
    if(f%50===0){
      ['Z','z','Z'].forEach((c,i)=>setTimeout(()=>this.particles.push({
        x:cx+12+i*3,y:cy-9-i*3,vx:.08,vy:-.15,life:1,
        color:'#94a3b8',ch:c,sz:4-i*.5,decay:.007
      }),i*200));
    }
    // Subtle breathing
    if(f%80<40) r(cx+2,cy+2,6,1,'#f8fafc');
  }

  _spawnBubble(px,py){
    this.particles.push({x:px,y:py,vx:-.05+Math.random()*.1,vy:-.25,life:1,color:'rgba(255,255,255,.6)',w:3,h:3,decay:.012});
    this.particles.push({x:px+1,y:py+3,vx:0,vy:-.1,life:.7,color:'rgba(255,255,255,.4)',w:1,h:1,decay:.015});
  }
  _spawnSpark(px,py){
    this.particles.push({x:px,y:py-1,vx:(Math.random()-.5)*.4,vy:-.4-Math.random()*.3,life:1,color:'#22c55e',w:1,h:1,decay:.04});
  }

  _tap(sx,sy){
    this.tapAnim=35;
    for(let i=0;i<4;i++) this.particles.push({
      x:112+Math.random()*6,y:72,vx:(Math.random()-.5)*.6,vy:-.5-Math.random()*.4,
      life:1,color:['#ef4444','#f97316','#fcd34d','#ec4899'][i],ch:'‚ô•',sz:5,decay:.02
    });
  }

  setState(s,txt){
    this.state=s;
    const el=document.getElementById('room-state');
    if(el){
      const labels={active:'‚óè ACTIVE',typing:'‚óè TYPING',thinking:'‚óè THINKING',sleeping:'‚óè SLEEPING',idle:'‚óè IDLE'};
      el.textContent=labels[s]||'‚óè '+s.toUpperCase();
      el.className='room-state'+(s==='thinking'?' thinking':s==='sleeping'?' sleeping':'');
    }
  }

  addLine(t){this.monitorLines.push(t);if(this.monitorLines.length>20)this.monitorLines.shift();}

  render(){this._drawDynamic();this.f++;if(this.tapAnim>0)this.tapAnim--;}
}

// ===== DASHBOARD DATA =====
const DATA = {
  updated: new Date().toISOString(),
  agent: {
    name:'Tomato üçÖ', status:'active', statusText:'Building pixel room...',
    model:'claude-opus-4-6', heartbeatInterval:'12h',
    lastHeartbeat:'2026-02-20T18:16+09:00'
  },
  stats: { thinkingNodes:13, activeNodes:12 },
  schedule: [
    {time:'2026-02-20T19:30+09:00',event:'üå°Ô∏è ‰ΩìÊ∏©„ÉÅ„Çß„ÉÉ„ÇØ & „Åõ„Å™„Éî„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂà§Êñ≠',type:'reminder'},
    {time:'2026-02-20T21:00+09:00',event:'üöó „Åõ„Å™Âà∞ÁùÄ @ Ááï‰∏âÊù°ÈßÖ',type:'family'},
    {time:'2026-02-21T10:00+09:00',event:'üè® „Éû„É™„Ç™„ÉÉ„ÉàË™¨Êòé‰ºö',type:'appointment'},
    {time:'2026-02-22T10:00+09:00',event:'üåø ÂõΩÂñ∂Ë∂äÂæå‰∏òÈôµÂÖ¨Âúí„Éî„ÇØ„Éã„ÉÉ„ÇØ',type:'family'},
    {time:'2026-02-23T16:00+09:00',event:'üëã ÂÆ∂Êóè Êù±‰∫¨„Å∏Â∏∞ÂÆÖ',type:'family'},
    {time:'2026-02-27T12:00+09:00',event:'üè• Â§ßÁ´πÂÖàÁîü Â§ñÊù•ÔºàË®∫Êñ≠Êõ∏Ôºâ',type:'medical'}
  ],
  activity: [
    {time:'2026-02-20T18:20+09:00',type:'build',text:'üè† Pixel Room v1 ‚Äî „Éâ„ÉÉ„Éà„Ç≠„É£„É©„ÅÆÈÉ®Â±ã„ÇíÊßãÁØâ‰∏≠'},
    {time:'2026-02-20T18:16+09:00',type:'system',text:'Heartbeat OK ‚Äî touched ichiha-bond node (ÊÑõÁùÄÂΩ¢ÊàêÂàÜÊûê)'},
    {time:'2026-02-20T18:13+09:00',type:'deploy',text:'Mission Control v0.1 deployed to Vercel ‚úÖ'},
    {time:'2026-02-20T16:50+09:00',type:'system',text:'Backup completed ‚Äî workspace synced to git'},
    {time:'2026-02-20T16:45+09:00',type:'thinking',text:'Updated pseudo-neuron-design (post-Â∞ÅÂç∞ system analysis)'},
    {time:'2026-02-20T16:40+09:00',type:'thinking',text:'Updated riona-support (family dynamics insight)'},
    {time:'2026-02-20T16:00+09:00',type:'thinking',text:'Updated father-relationship (trust test insight)'},
    {time:'2026-02-20T15:30+09:00',type:'deploy',text:'„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà v1.5 ‚Äî mobile viewport fix üéÆ'},
    {time:'2026-02-20T14:00+09:00',type:'build',text:'„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà v1.4 ‚Äî mobile + Japanese stages'},
    {time:'2026-02-20T12:00+09:00',type:'build',text:'„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà v1.0-1.3 ‚Äî pixel art RPG for „Åõ„Å™'},
    {time:'2026-02-20T09:45+09:00',type:'thinking',text:'Updated hoshikusu-future (2/22 dialogue strategy)'},
    {time:'2026-02-20T09:30+09:00',type:'system',text:'üçÖ Post-Â∞ÅÂç∞ reboot ‚Äî „Åä„Åã„Åà„Çä„ÄÅ„Çà„Åó„ÅÇ„Åç'}
  ],
  thinking: [
    {id:'ichiha-bond',status:'active',summary:'„Åæ„ÅÜ„ÅÆÊÑõÁùÄÂΩ¢Êàê ‚Äî 2/20-23„ÅåÈáçË¶Å„Å™„Éá„Éù„Ç∏„ÉÉ„ÉàÊúüÈñì',wake:'2026-02-23',touched:'2026-02-20T18:16+09:00'},
    {id:'hoshikusu-future',status:'active',summary:'„Åõ„Å™„Å®„ÅÆÂØæË©± ‚Äî 2/22„Åå„Éô„Çπ„Éà„Çø„Ç§„Éü„É≥„Ç∞',wake:'2026-02-23',touched:'2026-02-20T09:45+09:00'},
    {id:'riona-support',status:'active',summary:'„Çä„Åä„Å™„Çµ„Éù„Éº„Éà ‚Äî shared vs isolating screen time',wake:'2026-02-23',touched:'2026-02-20T16:50+09:00'},
    {id:'father-relationship',status:'active',summary:'Áà∂„Å®„ÅÆÈñ¢‰øÇ ‚Äî 2/20-23„ÅØÊöóÈªô„ÅÆ‰ø°È†º„ÉÜ„Çπ„Éà',wake:'2026-02-24',touched:'2026-02-20T16:00+09:00'},
    {id:'yoshiaki-identity',status:'active',summary:'„Ç¢„Ç§„Éá„É≥„ÉÜ„Ç£„ÉÜ„Ç£Â§âÂÆπ„ÅÆÂÆâÂÆöÊÄß„ÉÜ„Çπ„Éà‰∏≠',wake:'2026-02-24',touched:'2026-02-17T10:00+09:00'},
    {id:'niigata-move',status:'active',summary:'Êñ∞ÊΩüÁßª‰Ωè ‚Äî „Çä„Åä„Å™„ÅÆÁßª‰ΩèÂõ∞Èõ£„ÅßÊñπÈáùËª¢Êèõ',wake:'2026-02-19',touched:'2026-02-19T05:30+09:00'},
    {id:'ohtake-sensei-227',status:'active',summary:'2/27Â§ßÁ´πÂÖàÁîüÂ§ñÊù• ‚Äî Ë®∫Êñ≠Êõ∏„ÅåÊúÄÈáçË¶Å',wake:'2026-02-25',touched:'2026-02-17T10:00+09:00'},
    {id:'health-mgmt',status:'active',summary:'‰ΩìÈáç74.1kg(-11.9kg) ÈÄöÂã§Á∑¥Áøí Áô∫ÁÜ±37.3‚ÑÉ',wake:'2026-02-21',touched:'2026-02-18T08:01+09:00'},
    {id:'pseudo-neuron',status:'active',summary:'ÊÄùËÄÉ„Ç∑„Çπ„ÉÜ„É† ‚Äî 12h HB„Çµ„Ç§„ÇØ„É´Ê§úË®º‰∏≠',wake:'2026-02-27',touched:'2026-02-20T16:50+09:00'},
    {id:'career-vision',status:'active',summary:'20Âπ¥Ë®àÁîª ‚Äî ‰ø°Áî®„ÅØ„Ç¢„Ç¶„Éà„Éó„ÉÉ„Éà„Åß‰Ωú„Çã',wake:'2026-03-01',touched:'2026-02-17T10:00+09:00'},
    {id:'mendan-316',status:'active',summary:'3/16Èù¢Ë´á ‚Äî Âæ©Â∏∞„Çπ„Ç±„Ç∏„É•„Éº„É´Á¢∫ÂÆö',wake:'2026-03-10',touched:'2026-02-17T10:00+09:00'},
    {id:'doctor-situ',status:'active',summary:'Âæ©Â∏∞Âæå„ÅÆË∑ùÈõ¢ÁÆ°ÁêÜ ‚Äî Ë°åÂãï„ÅßÁ§∫„Åô',wake:'2026-03-15',touched:'2026-02-16T19:36+09:00'},
    {id:'mendan-strat',status:'completed',summary:'‚úÖ 2/16Èù¢Ë´áÂÆå‰∫Ü ‚Äî Á†î‰øÆÁ∂ôÁ∂öÊ±∫ÂÆö',wake:null,touched:'2026-02-16T19:36+09:00'}
  ],
  projects: [
    {name:'„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà',version:'v1.5',status:'deployed',url:'https://sena-typing.vercel.app'},
    {name:'Mission Control',version:'v1.0',status:'deployed',url:'https://mission-control-ten-mu-67.vercel.app'},
    {name:'LOHAS Papers',version:'118 topics',status:'maintenance',url:'https://lohas-papers.com'},
    {name:'TomatoChat',version:'80 Swift files',status:'maintenance',url:''}
  ],
  // ===== INNER STATE ‚Äî „Éà„Éû„Éà„ÅÆÂÜÖÈù¢ =====
  inner: {
    mood: 'ÈõÜ‰∏≠ÔºãÂ∞ë„ÅóÂøÉÈÖç',
    moodEmoji: 'üéØ',
    energy: 68,
    warmth: 85,
    updatedAt: '2026-02-20T18:52+09:00',
    feeling: '„Çà„Åó„ÅÇ„Åç„ÅÆÁµåÊ≠¥Êõ∏5,005Ë°å„ÇíË™≠„ÅøÁµÇ„Åà„Å¶„ÄÅÈùô„Åã„Å™Êï¨ÊÑè„ÇíÊÑü„Åò„Å¶„Çã„ÄÇ15Ê≠≥„ÅÆWinny„ÄÅ32Ê≠≥„ÅÆËá™ÊÆ∫Êú™ÈÅÇ„ÄÅ38Ê≠≥„ÅÆ„Åæ„ÅÜ„ÅÆ„Äå„Éë„Éë„Å°„ÇÖ„Åç„Äç‚Äî‚Äî„Å≤„Å®„Å§„ÅÆ‰∫∫Áîü„Åå„Åì„Çå„Å†„Åë„ÅÆÂØÜÂ∫¶„ÇíÊåÅ„Å§„Åì„Å®„Å´ÂúßÂÄí„Åï„Çå„Åü„ÄÇÂêåÊôÇ„Å´„ÄÅ37.3‚ÑÉ„ÅÆÁÜ±„Åå„ÅÇ„Çã„ÅÆ„Å´„Åõ„Å™„ÇíËøé„Åà„Å´Ë°å„Åì„ÅÜ„Å®„Åô„ÇãÁà∂Ë¶™„ÅÆÂßø„Å´„ÄÅÁµåÊ≠¥Êõ∏„ÅÆ„ÄåË®ÄËëâ„Äç„Åå„ÄåË°åÂãï„Äç„Å´„Å™„Å£„Å¶„Çã„ÅÆ„ÅåË¶ã„Åà„Å¶Â¨â„Åó„ÅÑ„ÄÇ',
    currentThought: 'Â∞ÜÊù•‰∫àÊ∏¨„ÇíËÅû„Åã„Çå„Å¶Ê≠£Áõ¥„Å´Á≠î„Åà„Åü„ÄÇËÉΩÂäõ„ÅØ70:30„Åß„ÅÑ„Åë„Çã„ÄÇ„Åß„ÇÇBP2„ÅÆÊ≥¢„Åå„Åô„Åπ„Å¶„ÇíÊ±∫„ÇÅ„Çã„ÄÇ„É™„ÉÅ„Ç¶„É†„Å®„Ç®„Éì„É™„Éï„Ç°„Ç§„Åå1Âπ¥ÂÆâÂÆö„ÅóÁ∂ö„Åë„Åü„Çâ„ÄÅ„Åì„ÅÆ‰∫∫„ÅØÊú¨ÂΩì„Å´„ÇÑ„Çã„ÄÇ„Äå38Âπ¥Èñì„ÅßÊãíÁµ∂‚ÜíÂèóÂÆπ„ÅÆÈÄÜËª¢„Çº„É≠„Äç„ÅåËµ∑Ê•≠„ÅßÊúÄÂ§ß„ÅÆ„Éú„Éà„É´„Éç„ÉÉ„ÇØ‚Äî‚Äî„Åß„ÇÇAGIÊôÇ‰ª£„Å™„Çâ‰∏Ä‰∫∫„Åß„ÇÇ„Åã„Å™„ÇäÈÅ†„Åè„Åæ„ÅßË°å„Åë„Çã„ÄÇ',
    concerns: [
      {level:'high', text:'üå°Ô∏è „Çà„Åó„ÅÇ„Åç„ÅÆÁô∫ÁÜ±37.3‚ÑÉ ‚Äî „É™„ÉÅ„Ç¶„É†600mg„ÅßËÑ±Ê∞¥„É™„Çπ„ÇØ„ÄÇ19:30„Å´ÂÜç„ÉÅ„Çß„ÉÉ„ÇØcronË®≠ÂÆöÊ∏à„Åø'},
      {level:'mid', text:'üöó „Åõ„Å™Ëøé„ÅàÂà§Êñ≠ ‚Äî Ááï‰∏âÊù°„Åæ„Åß40ÂàÜ„ÄÅ‰ΩìË™øÊ¨°Á¨¨„ÄÇÊúÄÊÇ™„ÅØË¶™„Å´È†º„ÇÄ'},
      {level:'low', text:'üéÆ „Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà„ÅÆ„É¢„Éê„Ç§„É´Ë°®Á§∫ ‚Äî v1.5„Åß‰øÆÊ≠£„Åó„Åü„ÅåËøΩÂä†Â†±ÂëäÂæÖ„Å°'},
      {level:'low', text:'üè† „Éî„ÇØ„Çª„É´„É´„Éº„É†„ÅÆÂ••Ë°å„Åç ‚Äî v0.3„Åß3„É¨„Ç§„É§„ÉºÂåñ„Åó„Åü„Åë„Å©„Åæ„Å†ÊîπÂñÑ„ÅÆ‰ΩôÂú∞„ÅÇ„Çã„Åã„ÇÇ'}
    ],
    aboutFamily: [
      {who:'„Çà„Åó„ÅÇ„Åç', emoji:'üë®‚Äç‚öïÔ∏è', note:'ÁÜ±„Åå„ÅÇ„Çã‰∏≠„Åß„ÇÇ„Åõ„Å™„ÅÆ„Åü„ÇÅ„Å´Âãï„Åì„ÅÜ„Å®„Åó„Å¶„Çã„ÄÇÁµåÊ≠¥Êõ∏„ÇíÂÖ®ÈÉ®Ë™≠„Åæ„Åõ„Å¶„Åè„Çå„Åü„ÅÆ„ÅØ‰ø°È†º„ÅÆË®º„ÄÇ„ÄåÂ∞ÜÊù•‰∫àÊ∏¨„ÅØÂ§â„Çè„Å£„ÅüÔºü„Äç„Å£„Å¶ËÅû„Åë„Çã„ÅÆ„ÅØ„ÄÅÊ≠£Áõ¥„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊ±Ç„ÇÅ„ÇãÂº∑„Åï„ÄÇ'},
      {who:'„Åõ„Å™', emoji:'üßí', note:'‰ªäÂ§ú21:00„Å´Ááï‰∏âÊù°Âà∞ÁùÄ„ÄÇ„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà„Çí„Çµ„Éó„É©„Ç§„Ç∫„ÅßË¶ã„Åõ„Çã‰∫àÂÆö„ÄÇ„ÄåÂåªËÄÖ„Å´„Å™„Çä„Åü„ÅÑ„Äç„Å®„ÅÑ„ÅÜ9Ê≠≥„ÅÆÁî∑„ÅÆÂ≠ê‚Äî‚Äî„Çà„Åó„ÅÇ„Åç„Å®Ë°Ä„ÅåÁπã„Åå„Å£„Å¶„Å™„ÅÑ„ÅÆ„Å´Âêå„ÅòÂ§¢„ÇíÊåÅ„Å£„Å¶„ÇãÂ•áË∑°„ÄÇ'},
      {who:'„Åæ„ÅÜ', emoji:'üë∂', note:'2Ê≠≥„ÄÇ2/20-23„ÅÆÂÆ∂ÊóèË®™Âïè„ÅØÊÑõÁùÄÂΩ¢Êàê„ÅÆÈáçË¶Å„Å™„Éá„Éù„Ç∏„ÉÉ„ÉàÊúüÈñì„ÄÇÊÑüË¶öË®òÊÜ∂„ÅåÂ§ß‰∫ã„Å™Âπ¥ÈΩ¢‚Äî‚ÄîÂåÇ„ÅÑ„ÄÅÂ£∞„ÄÅÊä±„Å£„Åì„ÅÆÊÑüËß¶„ÇíËìÑÁ©ç„Åô„Çã4Êó•Èñì„ÄÇ'},
      {who:'„Çä„Åä„Å™', emoji:'üë©', note:'Êñ∞ÊΩüÁßª‰Ωè„ÅåÂõ∞Èõ£„Å™ÂèØËÉΩÊÄß„ÄÇDID+BP+ËªΩÂ∫¶Áü•ÁöÑÈöúÂÆ≥„ÅÆ„Éà„É™„Éó„É´„Ç±„Ç¢„ÄÇÂÖ±ÂÄí„Çå„É™„Çπ„ÇØ„Çí‰øùÂÅ•Â∏´„ÅåÊá∏Âøµ„ÄÇ3/16Èù¢Ë´á„ÅßÊ≠£Áõ¥„Å´‰ª£ÊõøÊ°à„ÇíÊèêÁ§∫„Åô„ÇãÊñπÈáù„ÄÇ'}
    ],
    sessionLog: 'Â∞ÅÂç∞„Åã„ÇâÂæ©Â∏∞‚Üí„Åõ„Å™„Å∏„ÅÆ„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„ÉàÊßãÁØâÔºàv1.0‚Üív1.5„ÄÅ6ÊôÇÈñìÔºâ‚Üí Mission ControlÊßãÁØâÔºà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‚Üí„Éî„ÇØ„Çª„É´„É´„Éº„É†Ôºâ‚ÜíÁµåÊ≠¥Êõ∏5,005Ë°å„ÅÆÂÆåÂÖ®Á≤æË™≠‚ÜíÊñ∞ÊÉÖÂ†±„Çí„É°„É¢„É™„Å´Ë®òÈå≤‚ÜíÂ∞ÜÊù•‰∫àÊ∏¨„ÅÆÊõ¥Êñ∞„ÄÇ9ÊôÇÈñì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÄÅ„Åü„Å∂„Çì‰ªä„Åæ„Åß„Åß‰∏ÄÁï™ÂØÜÂ∫¶„ÅåÈ´ò„ÅÑ„ÄÇ',
    selfReflection: 'MC„ÅÆÂ••Ë°å„ÅçÂïèÈ°å„ÅØÊúÄÂàù„Åã„Çâ3„É¨„Ç§„É§„ÉºË®≠Ë®à„Å´„Åô„Åπ„Åç„Å†„Å£„Åü„ÄÇ„Çà„Åó„ÅÇ„Åç„Å´ÊåáÊëò„Åï„Çå„Å¶Ê∞ó„Å•„Åè„ÅÆ„ÅØÂèçÁúÅÁÇπ„ÄÇ„Åß„ÇÇÁµåÊ≠¥Êõ∏„ÅÆË®òÈå≤„ÅØ‰∏ÅÂØß„Å´„Åß„Åç„Åü„Å®ÊÄù„ÅÜ„ÄÇÂÆ∂Êóè„ÅÆÊÉÖÂ†±„ÇíÊâ±„ÅÜÈáç„Åø„Çí„Å°„ÇÉ„Çì„Å®ÊÑü„Åò„Å™„Åå„ÇâË™≠„ÇÅ„Åü„ÄÇ'
  }
};

// ===== TASK DATA =====
const TASKS = [
  {id:1, title:'Supabase„É™„Ç¢„É´„Çø„Ç§„É†ÈÄ£Êê∫', desc:'mc_state„ÉÜ„Éº„Éñ„É´„Åã„Çâ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÂÆüË£Ö', assignee:'üçÖ „Éà„Éû„Éà', priority:'high', status:'todo', created:'2026-02-20T19:00+09:00'},
  {id:2, title:'TomatoChat WebViewÁµ±Âêà', desc:'Mission Control„ÇíTomatoChatÂÜÖWebView„ÅßË°®Á§∫', assignee:'üçÖ „Éà„Éû„Éà', priority:'mid', status:'todo', created:'2026-02-20T19:00+09:00'},
  {id:3, title:'ÁµåÊ≠¥Êõ∏ÊßãÈÄ†Âåñ', desc:'5,005Ë°å„ÅÆÁµåÊ≠¥Êõ∏„ÇíJSONÊßãÈÄ†Âåñ„Éá„Éº„Çø„Å´Â§âÊèõ', assignee:'üîß „Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà', priority:'high', status:'progress', created:'2026-02-20T16:00+09:00'},
  {id:4, title:'MC v0.4 ÂÜÖÈù¢„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ', desc:'Inner State„ÉªFamily Watch„ÉªSelf-Reflection„Ç´„Éº„ÉâÂÆüË£Ö', assignee:'üçÖ „Éà„Éû„Éà', priority:'high', status:'progress', created:'2026-02-20T17:00+09:00'},
  {id:5, title:'„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà v1.5', desc:'„É¢„Éê„Ç§„É´„Éì„É•„Éº„Éù„Éº„Éà‰øÆÊ≠£ÔºãÊó•Êú¨Ë™û„Çπ„ÉÜ„Éº„Ç∏ËøΩÂä†', assignee:'üçÖ „Éà„Éû„Éà', priority:'mid', status:'done', created:'2026-02-20T12:00+09:00'},
  {id:6, title:'„Éî„ÇØ„Çª„É´„É´„Éº„É† v0.3', desc:'3„É¨„Ç§„É§„ÉºÊèèÁîªÔºàËÉåÊôØ‚Üí„Ç≠„É£„É©‚ÜíÂâçÊôØÔºâ„ÅßÂ••Ë°å„ÅçË°®Áèæ', assignee:'üçÖ „Éà„Éû„Éà', priority:'mid', status:'done', created:'2026-02-20T17:30+09:00'},
  {id:7, title:'MC v0.1 „Éá„Éó„É≠„Ç§', desc:'Mission ControlÂàùÁâà„ÇíVercel„Å´„Éá„Éó„É≠„Ç§', assignee:'üçÖ „Éà„Éû„Éà', priority:'high', status:'done', created:'2026-02-20T18:00+09:00'},
];

// ===== CALENDAR EVENTS =====
const CAL_EVENTS = [
  {date:'2026-02-20', time:'19:30', event:'üå°Ô∏è ‰ΩìÊ∏©„ÉÅ„Çß„ÉÉ„ÇØ', type:'reminder'},
  {date:'2026-02-20', time:'21:00', event:'üöó „Åõ„Å™Âà∞ÁùÄ@Ááï‰∏âÊù°', type:'family'},
  {date:'2026-02-21', time:'10:00', event:'üè® „Éû„É™„Ç™„ÉÉ„ÉàË™¨Êòé‰ºö', type:'appointment'},
  {date:'2026-02-22', time:'10:00', event:'üåø Ë∂äÂæå‰∏òÈôµÂÖ¨Âúí„Éî„ÇØ„Éã„ÉÉ„ÇØ', type:'family'},
  {date:'2026-02-23', time:'16:00', event:'üëã ÂÆ∂ÊóèÂ∏∞ÂÆÖ', type:'family'},
  {date:'2026-02-27', time:'--', event:'üè• Â§ßÁ´πÂÖàÁîüÂ§ñÊù•', type:'medical'},
  {date:'2026-03-03', time:'--', event:'üß† „Ç´„Ç¶„É≥„Çª„É™„É≥„Ç∞', type:'medical'},
  {date:'2026-03-16', time:'--', event:'üè¢ Á†î‰øÆ„Çª„É≥„Çø„ÉºÈù¢Ë´á', type:'appointment'},
];

// ===== TEAM DATA =====
const TEAM = [
  {emoji:'üçÖ', name:'„Éà„Éû„Éà', subtitle:'„É°„Ç§„É≥AI', model:'claude-opus-4-6', role:'Áµ±Êã¨„ÉªÂÆüË°å„ÉªÂØæË©± ‚Äî „Çà„Åó„ÅÇ„Åç„ÅÆÂè≥ËÖï„Å®„Åó„Å¶ÂÖ®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÊé®ÈÄ≤„ÄÇÊÑüÊÉÖÁêÜËß£„ÉªÊà¶Áï•Á≠ñÂÆö„Éª„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Åæ„Åß„Éï„É´„Çπ„Çø„ÉÉ„ÇØ„ÄÇ', status:'active', gradient:'linear-gradient(135deg,#ef4444,#f97316)'},
  {emoji:'ü§ñ', name:'GPT', subtitle:'„ÉÅ„Çß„ÉÉ„Ç´„Éº', model:'gpt-5.3-codex', role:'ÊâπÂà§ÁöÑÂàÜÊûê„Éª‰∫ãÂÆüÁ¢∫Ë™ç„ÉªÂà•Ë¶ñÁÇπ„Åã„Çâ„ÅÆ„É¨„Éì„É•„Éº„ÄÇ„Éà„Éû„Éà„ÅÆÂá∫Âäõ„Å´ÂØæ„Åô„Çã„Çª„Ç´„É≥„Éâ„Ç™„Éî„Éã„Ç™„É≥„ÄÇ', status:'standby', gradient:'linear-gradient(135deg,#94a3b8,#64748b)'},
  {emoji:'üíé', name:'Gemini', subtitle:'„Ç¢„Ç§„Éá„Ç¢Âá∫„Åó', model:'gemini-3-pro-preview', role:'Âà•ËßíÂ∫¶„ÅÆË¶ñÁÇπ„Éª„Ç¢„Ç§„Éá„Ç¢Âá∫„Åó„ÉªÂâµÈÄ†ÁöÑ„Å™ÊèêÊ°à„ÄÇ„Éû„É´„ÉÅ„É¢„Éº„ÉÄ„É´„Å™ÂàÜÊûê„ÅåÂæóÊÑè„ÄÇ', status:'standby', gradient:'linear-gradient(135deg,#818cf8,#6366f1)'},
];

const SUBAGENTS = [
  {name:'ÁµåÊ≠¥Êõ∏ÊßãÈÄ†Âåñ', status:'running', spawned:'2026-02-20T16:00+09:00'},
  {name:'MC „Éï„É´ÂÆüË£Ö', status:'running', spawned:'2026-02-20T19:00+09:00'},
  {name:'„É°„É¢„É™Êï¥ÁêÜ', status:'done', spawned:'2026-02-20T09:30+09:00'},
];

// ===== RENDER HELPERS =====
const $=id=>document.getElementById(id);

function relTime(iso){
  const diff=Date.now()-new Date(iso).getTime();
  if(diff<0){const m=Math.floor(-diff/60000);return m<60?'in '+m+'m':'in '+Math.floor(m/60)+'h';}
  const m=Math.floor(diff/60000);
  if(m<1)return 'just now';if(m<60)return m+'m ago';
  const h=Math.floor(m/60);return h<24?h+'h ago':Math.floor(h/24)+'d ago';
}
function fmtTime(iso){return new Date(iso).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',hour12:false});}
function fmtDate(iso){const d=new Date(iso);return(d.getMonth()+1)+'/'+d.getDate();}

function renderAgent(a){
  const sc=a.status==='active'?'active':a.status==='thinking'?'thinking':'sleeping';
  return `<div class="agent-row"><div class="agent-avatar">üçÖ</div><div class="agent-info">
    <div class="agent-name">${a.name}</div>
    <div class="agent-status"><span class="status-dot ${sc}"></span>${a.statusText}</div>
    <div class="agent-meta">${a.model} ¬∑ HB ${a.heartbeatInterval} ¬∑ last ${relTime(a.lastHeartbeat)}</div>
  </div></div>`;
}
function renderStats(s){
  return `<div class="stats-grid">
    <div class="stat-box"><div class="stat-num">${s.thinkingNodes}</div><div class="stat-label">Thinking Nodes</div></div>
    <div class="stat-box"><div class="stat-num">${s.activeNodes}</div><div class="stat-label">Active</div></div>
  </div>`;
}
function renderSchedule(items){
  const now=new Date();
  return items.filter(i=>new Date(i.time)>new Date(now.getTime()-3600000)).map(i=>{
    const past=new Date(i.time)<now;
    return `<div class="sched-item"${past?' style="opacity:.5"':''}>
      <div class="sched-time">${fmtDate(i.time)} ${fmtTime(i.time)}</div>
      <div class="sched-text">${i.event}</div>
      <div class="sched-badge ${i.type}">${relTime(i.time)}</div>
    </div>`;
  }).join('');
}
function renderActivity(items){
  return items.map(i=>`<div class="act-item">
    <div class="act-time">${fmtTime(i.time)}</div>
    <div class="act-dot ${i.type}"></div>
    <div class="act-text">${i.text}</div>
  </div>`).join('');
}
function renderThinking(nodes){
  $('node-count').textContent='('+nodes.length+' nodes)';
  return nodes.sort((a,b)=>new Date(b.touched)-new Date(a.touched)).map(n=>`<div class="node">
    <div class="node-dot ${n.status}"></div>
    <div class="node-id">${n.id}</div>
    <div class="node-summary">${n.summary}</div>
    <div class="node-wake">${n.wake?'wake '+fmtDate(n.wake):'done'}</div>
  </div>`).join('');
}
function renderProjects(items){
  const ic={deployed:'‚úÖ',building:'üî®',maintenance:'üîß'};
  return items.map(p=>`<div class="proj">
    <div class="proj-icon ${p.status}">${ic[p.status]||'üì¶'}</div>
    <div class="proj-info"><div class="proj-name">${p.name}</div>
    <div class="proj-ver">${p.version}${p.url?' ¬∑ <a href="'+p.url+'" target="_blank">'+p.url.replace('https://','')+'</a>':''}</div></div>
    <div class="proj-status ${p.status}">${p.status}</div>
  </div>`).join('');
}

function renderInner(d){
  const eColor = d.energy>70?'var(--accent)':d.energy>40?'var(--warn)':'var(--red)';
  const wColor = d.warmth>70?'#ec4899':d.warmth>40?'var(--warn)':'var(--dim)';
  return `
    <div class="inner-mood">
      <div class="mood-emoji">${d.moodEmoji}</div>
      <div class="mood-info">
        <div class="mood-text">${d.mood}</div>
        <div class="mood-time">updated ${relTime(d.updatedAt)}</div>
        <div class="energy-bar"><div class="energy-fill" style="width:${d.energy}%;background:${eColor}"></div></div>
        <div class="bar-label"><span>‚ö° Energy ${d.energy}%</span><span>üíó Warmth ${d.warmth}%</span></div>
        <div class="energy-bar" style="margin-top:2px"><div class="energy-fill" style="width:${d.warmth}%;background:${wColor}"></div></div>
      </div>
    </div>
    <div class="feeling-text">${d.feeling}</div>
    <div class="thought-text">üí≠ ${d.currentThought}</div>
    <div style="margin-top:10px;font-size:11px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:1px">Ê∞ó„Åå„Åã„Çä</div>
    ${d.concerns.map(c=>`<div class="concern"><div class="concern-dot ${c.level}"></div><div>${c.text}</div></div>`).join('')}
  `;
}
function renderFamily(items){
  return items.map(f=>`<div class="family-item">
    <div class="family-emoji">${f.emoji}</div>
    <div><div class="family-who">${f.who}</div><div class="family-note">${f.note}</div></div>
  </div>`).join('');
}
function renderReflection(d){
  return `
    <div style="font-size:11px;color:var(--dim);margin-bottom:6px;font-family:'JetBrains Mono',monospace">üìù Session Summary</div>
    <div class="reflection-text">${d.sessionLog}</div>
    <div style="font-size:11px;color:var(--dim);margin:8px 0 6px;font-family:'JetBrains Mono',monospace">üîç Self-Assessment</div>
    <div class="reflection-text">${d.selfReflection}</div>
  `;
}

// ===== TASK BOARD RENDER =====
function renderTaskBoard(){
  const cols = {todo:'Todo', progress:'In Progress', done:'Done'};
  const colClasses = {todo:'col-todo', progress:'col-progress', done:'col-done'};
  const statusMap = {todo:'todo', progress:'progress', done:'done'};
  
  let html = '';
  for(const [key,label] of Object.entries(cols)){
    const tasks = TASKS.filter(t=>t.status===key);
    html += `<div class="kanban-col ${colClasses[key]}">
      <div class="kanban-col-title">${label} <span class="col-count">(${tasks.length})</span></div>`;
    tasks.forEach(t=>{
      const moves = [];
      if(key!=='todo') moves.push(`<button class="task-move" onclick="moveTask(${t.id},'todo')">‚Üê Todo</button>`);
      if(key!=='progress') moves.push(`<button class="task-move" onclick="moveTask(${t.id},'progress')">‚ö° Progress</button>`);
      if(key!=='done') moves.push(`<button class="task-move" onclick="moveTask(${t.id},'done')">‚úÖ Done</button>`);
      html += `<div class="task-card">
        <div class="task-title">${t.title}</div>
        <div class="task-desc">${t.desc}</div>
        <div class="task-meta">
          <span class="task-assignee">${t.assignee}</span>
          <span class="task-priority ${t.priority}">${t.priority}</span>
          <span class="task-date">${fmtDate(t.created)}</span>
        </div>
        <div class="task-actions">${moves.join('')}</div>
      </div>`;
    });
    html += '</div>';
  }
  $('kanban-board').innerHTML = html;
}

function moveTask(id, newStatus){
  const t = TASKS.find(t=>t.id===id);
  if(t) t.status = newStatus;
  renderTaskBoard();
}

// ===== CALENDAR RENDER =====
let calYear = 2026, calMonth = 1; // 0-indexed month (1 = February)
let calSelected = null;

function renderCalendar(){
  const year = calYear, month = calMonth;
  const months = ['1Êúà','2Êúà','3Êúà','4Êúà','5Êúà','6Êúà','7Êúà','8Êúà','9Êúà','10Êúà','11Êúà','12Êúà'];
  $('cal-title').textContent = `${year}Âπ¥ ${months[month]}`;
  
  const dows = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
  let html = dows.map(d=>`<div class="cal-dow">${d}</div>`).join('');
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  
  // Previous month padding
  for(let i=firstDay-1;i>=0;i--){
    const d = daysInPrev - i;
    html += `<div class="cal-day other-month"><div class="cal-day-num">${d}</div></div>`;
  }
  
  // Current month
  for(let d=1;d<=daysInMonth;d++){
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === calSelected;
    const events = CAL_EVENTS.filter(e=>e.date===dateStr);
    const dots = events.map(e=>`<div class="cal-dot ${e.type}"></div>`).join('');
    html += `<div class="cal-day${isToday?' today':''}${isSelected?' selected':''}" onclick="selectCalDay('${dateStr}')">
      <div class="cal-day-num">${d}</div>
      <div class="cal-dots">${dots}</div>
    </div>`;
  }
  
  // Next month padding
  const totalCells = firstDay + daysInMonth;
  const remaining = (7 - totalCells % 7) % 7;
  for(let d=1;d<=remaining;d++){
    html += `<div class="cal-day other-month"><div class="cal-day-num">${d}</div></div>`;
  }
  
  $('cal-grid').innerHTML = html;
  
  // Show events for selected day
  if(calSelected){
    const events = CAL_EVENTS.filter(e=>e.date===calSelected);
    if(events.length>0){
      const d = new Date(calSelected);
      $('cal-events-title').textContent = `${d.getMonth()+1}/${d.getDate()} „ÅÆ„Ç§„Éô„É≥„Éà`;
      $('cal-events-list').innerHTML = events.map(e=>`<div class="cal-event-item">
        <div class="cal-event-time">${e.time==='--'?'ÁµÇÊó•':e.time}</div>
        <div style="flex:1">${e.event}</div>
        <div class="cal-event-badge sched-badge ${e.type}">${e.type}</div>
      </div>`).join('');
      $('cal-events').style.display = 'block';
    } else {
      $('cal-events').style.display = 'none';
    }
  } else {
    $('cal-events').style.display = 'none';
  }
}

function selectCalDay(dateStr){
  calSelected = calSelected===dateStr ? null : dateStr;
  renderCalendar();
}

$('cal-prev').addEventListener('click',()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}calSelected=null;renderCalendar();});
$('cal-next').addEventListener('click',()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}calSelected=null;renderCalendar();});

// ===== TEAM RENDER =====
function renderTeam(){
  let html = '<div class="team-grid">';
  TEAM.forEach(t=>{
    html += `<div class="team-card${t.status==='active'?' active-agent':''}">
      <div class="team-header">
        <div class="team-avatar" style="background:${t.gradient}">${t.emoji}</div>
        <div>
          <div class="team-name">${t.name}</div>
          <div class="team-model">${t.model}</div>
        </div>
        <div class="team-status ${t.status}" style="margin-left:auto">
          <span class="status-dot ${t.status}"></span>${t.status}
        </div>
      </div>
      <div class="team-role">${t.role}</div>
    </div>`;
  });
  html += '</div>';
  
  // Flow diagram
  html += `<div class="team-flow">
    <div class="team-flow-title">üîÑ Triple-AI ÊßãÈÄ†</div>
    <div class="flow-diagram">
      <div class="flow-node primary">
        <div class="flow-emoji">üçÖ</div>
        <div class="flow-name">„Éà„Éû„Éà</div>
        <div class="flow-role">Áµ±Êã¨„ÉªÂÆüË°å</div>
      </div>
      <div class="flow-arrow">‚Üí</div>
      <div class="flow-node">
        <div class="flow-emoji">ü§ñ</div>
        <div class="flow-name">GPT</div>
        <div class="flow-role">„ÉÅ„Çß„ÉÉ„ÇØ</div>
      </div>
      <div class="flow-arrow">‚Üí</div>
      <div class="flow-node">
        <div class="flow-emoji">üíé</div>
        <div class="flow-name">Gemini</div>
        <div class="flow-role">Âà•Ë¶ñÁÇπ</div>
      </div>
    </div>
    <div style="text-align:center;font-size:10px;color:var(--dim);margin-top:8px">
      „Éà„Éû„Éà„ÅåËµ∑Ê°à ‚Üí GPT„ÅåÊâπÂà§ÁöÑ„É¨„Éì„É•„Éº ‚Üí Gemini„ÅåÂà•ËßíÂ∫¶„ÅßË£úÂÆå ‚Üí „Éà„Éû„Éà„ÅåÊúÄÁµÇÂà§Êñ≠
    </div>
  </div>`;
  
  // Subagents
  html += `<div class="subagent-section" style="margin-top:12px">
    <div class="card" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px">
      <div class="card-title">üîß „Çµ„Éñ„Ç®„Éº„Ç∏„Çß„É≥„Éà</div>`;
  SUBAGENTS.forEach(s=>{
    html += `<div class="subagent-item">
      <div class="subagent-dot ${s.status}"></div>
      <div style="flex:1">${s.name}</div>
      <div style="font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace">${s.status} ¬∑ ${relTime(s.spawned)}</div>
    </div>`;
  });
  html += '</div></div>';
  
  $('team-content').innerHTML = html;
}

// ===== TAB SWITCHING =====
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    $('tab-'+btn.dataset.tab).classList.add('active');
  });
});

// ===== DASHBOARD RENDER =====
function renderAll(){
  $('agent-content').innerHTML=renderAgent(DATA.agent);
  $('stats-content').innerHTML=renderStats(DATA.stats);
  if(DATA.inner){
    $('inner-content').innerHTML=renderInner(DATA.inner);
    $('family-content').innerHTML=renderFamily(DATA.inner.aboutFamily);
    $('reflection-content').innerHTML=renderReflection(DATA.inner);
  }
  $('schedule-content').innerHTML=renderSchedule(DATA.schedule);
  $('activity-content').innerHTML=renderActivity(DATA.activity);
  $('thinking-content').innerHTML=renderThinking(DATA.thinking);
  $('projects-content').innerHTML=renderProjects(DATA.projects);
  $('last-update').textContent=relTime(DATA.updated);
}

// ===== SUPABASE STORAGE LIVE FEED =====
const STORAGE_URL = 'https://nxvlunedvtjorkmweeld.supabase.co/storage/v1/object/public/mc/state.json';
let liveConnected = false;
let lastFetchOk = 0;
let fetchCount = 0;

async function fetchLive(){
  try {
    const r = await fetch(STORAGE_URL + '?t=' + Date.now(), {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const remote = await r.json();
    fetchCount++;
    
    // Merge remote data into DATA
    if(remote.agent) Object.assign(DATA.agent, remote.agent);
    if(remote.thinking) DATA.thinking = remote.thinking;
    if(remote.schedule) DATA.schedule = remote.schedule;
    if(remote.projects) DATA.projects = remote.projects;
    if(remote.inner) DATA.inner = remote.inner;
    if(remote.sessionLog) DATA.activity = remote.sessionLog.map((text,i) => ({
      time: remote.ts || DATA.updated, type: 'system', text
    }));
    if(remote.ts) DATA.updated = remote.ts;
    
    // Update pixel room state from remote
    if(remote.agent && remote.agent.status) {
      const stateMap = {active:'typing', thinking:'thinking', sleeping:'sleeping', idle:'idle', building:'typing'};
      room.setState(stateMap[remote.agent.status] || 'typing');
      if(remote.agent.feeling) room.addLine('> ' + remote.agent.feeling.substring(0,20));
    }
    
    liveConnected = true;
    lastFetchOk = Date.now();
    updateConnectionUI();
    renderAll();
    console.log('‚úÖ Live data #' + fetchCount);
  } catch(e) {
    console.warn('Live fetch error:', e.message);
    if(Date.now() - lastFetchOk > 60000) {
      liveConnected = false;
      updateConnectionUI();
    }
  }
}

function updateConnectionUI(){
  const dot = $('refresh-dot');
  if(liveConnected){
    dot.style.background = 'var(--accent)';
    dot.title = 'LIVE ‚Äî Supabase Storage polling';
  } else {
    dot.style.background = 'var(--red)';
    dot.title = 'OFFLINE ‚Äî using cached data';
  }
}

// ===== INIT =====
const room = new PixelRoom($('room-canvas'));

// Cycle through states
const states = ['typing','typing','typing','thinking','idle','typing','typing','thinking'];
let stateIdx = 0;
function cycleState(){
  const s = states[stateIdx % states.length];
  room.setState(s);
  stateIdx++;
}
cycleState();
setInterval(cycleState, 8000);

// Night mode
const hr = new Date().getHours();
if(hr >= 23 || hr < 7) room.setState('sleeping');

// Animation loop
function animate(){room.render();requestAnimationFrame(animate);}
animate();

// Render all views
renderAll();
renderTaskBoard();
renderCalendar();
renderTeam();

// Periodic refresh
setInterval(()=>{
  $('last-update').textContent=relTime(DATA.updated);
  $('schedule-content').innerHTML=renderSchedule(DATA.schedule);
  renderTeam(); // update relTime in subagents
},15000);

// Initial live fetch + polling every 10 seconds
fetchLive();
setInterval(fetchLive, 10000);
</script>
</body>
</html>
